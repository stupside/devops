---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: oidc-securitypolicy-generator
  annotations:
    policies.kyverno.io/title: OIDC SecurityPolicy Generator
    policies.kyverno.io/description: |
      Automatically generates SecurityPolicy resources for HTTPRoutes
      labeled with oidc.security/enabled=true
spec:
  background: true
  schemaValidation: false
  rules:
    - name: generate-security-policy
      match:
        any:
          - resources:
              kinds:
                - HTTPRoute
              selector:
                matchLabels:
                  oidc.security/enabled: "true"

      context:
        - name: profile
          configMap:
            name: oidc-profiles
            namespace: envoy-gateway-system

      preconditions:
        all:
          - key: "{{ request.object.metadata.labels.\"oidc.security/profile\" || '' }}"
            operator: NotEquals
            value: ""
          - key: "{{ profile.data.\"profiles.json\" | parse_json(@).\"{{ request.object.metadata.labels.\"oidc.security/profile\" }}\" || '' }}"
            operator: NotEquals
            value: ""

      generate:
        synchronize: true
        apiVersion: gateway.envoyproxy.io/v1alpha1
        kind: SecurityPolicy
        name: "{{ request.object.metadata.name }}-oidc"
        namespace: "{{ request.object.metadata.namespace }}"
        data:
          metadata:
            labels:
              app.kubernetes.io/managed-by: kyverno
              oidc.security/generated: "true"
              oidc.security/profile: "{{ request.object.metadata.labels.\"oidc.security/profile\" }}"
          spec:
            targetRefs:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
                name: "{{ request.object.metadata.name }}"
            oidc:
              provider:
                backendRefs:
                  - group: gateway.envoyproxy.io
                    kind: Backend
                    name: hydra-provider
                    namespace: envoy-gateway-system
                    port: 4444
                issuer: "https://hydra.${cluster_domain}"
              clientID: envoy-gateway
              clientSecret:
                name: oidc-client-secret
                namespace: envoy-gateway-system
              redirectURL: "https://oidc.${cluster_domain}/oauth2/callback"
              logoutPath: "/oauth2/logout"
              cookieDomain: "${cluster_domain}"
              forwardAccessToken: true
              scopes: "{{ profile.data.\"profiles.json\" | parse_json(@).\"{{ request.object.metadata.labels.\"oidc.security/profile\" }}\".scopes }}"
            extAuth:
              grpc:
                backendRef:
                  kind: Service
                  name: kyverno-authz-server
                  namespace: kyverno
                  port: 9081
