---
apiVersion: v1
kind: ConfigMap
metadata:
  name: opa-policy
  namespace: opa
  labels:
    app: opa
data:
  authz.rego: |
    package envoy.authz

    import rego.v1

    # Default deny
    default allow := false

    # Kubernetes API configuration
    k8s_api_url := "https://kubernetes.default.svc"
    k8s_token_path := "/var/run/secrets/kubernetes.io/serviceaccount/token"
    k8s_ca_cert_path := "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"

    # Extract JWT token from Authorization header
    token := t if {
        v := input.attributes.request.http.headers.authorization
        startswith(v, "Bearer ")
        t := substring(v, 7, -1)
    }

    # Decode JWT payload (assuming it's already validated by Envoy Gateway OIDC)
    token_payload := payload if {
        [_, payload, _] := io.jwt.decode(token)
    }

    # Extract email claim
    email := token_payload.email

    # Extract hostname from request
    hostname := input.attributes.request.http.headers[":authority"]

    # Get ConfigMap from Kubernetes API
    get_configmap(namespace, name) := result if {
        # Read service account token
        token_data := file.read(k8s_token_path)

        # Make API request
        response := http.send({
            "url": sprintf("%s/api/v1/namespaces/%s/configmaps/%s", [k8s_api_url, namespace, name]),
            "method": "GET",
            "headers": {
                "Authorization": sprintf("Bearer %s", [token_data]),
            },
            "tls_ca_cert_file": k8s_ca_cert_path,
            "raise_error": false,
        })

        response.status_code == 200
        result := response.body
    }

    # Load hostname-to-profile mappings
    hostname_mappings_cm := get_configmap("envoy-gateway-system", "oidc-hostname-profiles")
    hostname_mappings_raw := hostname_mappings_cm.data["mappings.json"]
    hostname_mappings := json.unmarshal(hostname_mappings_raw)

    # Get profile for this hostname
    profile := hostname_mappings[hostname]

    # Load profiles configuration
    profiles_cm := get_configmap("envoy-gateway-system", "oidc-profiles")
    profiles_raw := profiles_cm.data["profiles.json"]
    profiles := json.unmarshal(profiles_raw)

    # Get allowed emails for this profile
    allowed_emails := profiles[profile].allowedEmails

    # Authorization decision: allow if email is in allowlist
    allow if {
        email
        profile
        allowed_emails
        email in allowed_emails
    }

    # Custom response headers
    headers["x-user-email"] := email if allow
    headers["x-profile"] := profile if allow
    headers["x-authorized-by"] := "opa" if allow

    # Denied response body
    body := sprintf("Access denied: %s not authorized for %s", [email, hostname]) if {
        not allow
        email
    }

    body := "Authentication required" if {
        not allow
        not email
    }
